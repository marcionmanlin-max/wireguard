name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v1.0.0)'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client-windows/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Pillow (icon conversion)
        run: pip install Pillow

      - name: Prepare icons
        shell: python
        run: |
          import os, shutil
          from PIL import Image

          src_dir = "frontend/public/icons"
          dst_dir = "client-windows/assets/icons"
          os.makedirs(dst_dir, exist_ok=True)

          # Copy all PNGs
          for f in os.listdir(src_dir):
              if f.endswith(".png"):
                  shutil.copy2(f"{src_dir}/{f}", f"{dst_dir}/{f}")
                  print(f"  copied {f}")

          # Create tray icons (copy 48x48 or 96x96)
          for src_name, dst_name in [
              ("icon-96x96.png",  "tray-disconnected.png"),
              ("icon-96x96.png",  "tray-connected.png"),
          ]:
              src = f"{dst_dir}/{src_name}"
              dst = f"{dst_dir}/{dst_name}"
              if os.path.exists(src) and not os.path.exists(dst):
                  shutil.copy2(src, dst)
                  print(f"  created {dst_name}")

          # Convert 512x512 PNG to multi-size ICO
          png_path = f"{dst_dir}/icon-512x512.png"
          ico_path = f"{dst_dir}/icon.ico"
          if os.path.exists(png_path):
              img = Image.open(png_path).convert("RGBA")
              sizes = [(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)]
              imgs = [img.resize(s, Image.LANCZOS) for s in sizes]
              imgs[0].save(ico_path, format="ICO", sizes=sizes, append_images=imgs[1:])
              print(f"  created icon.ico ({os.path.getsize(ico_path)//1024} KB)")
          else:
              print("WARNING: icon-512x512.png not found, using default icon")

      - name: Install dependencies
        working-directory: client-windows
        run: npm ci

      - name: Build renderer (Vite)
        working-directory: client-windows
        run: npx vite build --config vite.renderer.config.js

      - name: Build Windows installer
        working-directory: client-windows
        run: npx electron-builder --win nsis portable --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist output
        working-directory: client-windows
        run: dir dist-electron

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || inputs.version }}
          name: IonMan DNS ${{ github.ref_name || inputs.version }}
          draft: false
          prerelease: false
          files: |
            client-windows/dist-electron/IonManDNS-Setup-*.exe
            client-windows/dist-electron/IonManDNS-Portable-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
